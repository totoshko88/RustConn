name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libvte-2.91-gtk4-dev \
            libadwaita-1-dev \
            libdbus-1-dev \
            libssl-dev \
            pkg-config \
            debhelper \
            dh-cargo \
            devscripts

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Move deb to workspace
        run: |
          mkdir -p dist
          mv ../rustconn_*.deb dist/

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

  build-appimage:
    name: Build AppImage
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libvte-2.91-gtk4-dev \
            libadwaita-1-dev \
            libdbus-1-dev \
            libssl-dev \
            pkg-config \
            libfuse2

      - name: Build release
        run: cargo build --release -p rustconn -p rustconn-cli

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-gtk.sh

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/icons/hicolor/128x128/apps
          mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps
          mkdir -p AppDir/usr/share/icons/hicolor/48x48/apps
          mkdir -p AppDir/usr/share/metainfo
          
          cp target/release/rustconn AppDir/usr/bin/
          cp target/release/rustconn-cli AppDir/usr/bin/
          cp rustconn/assets/org.rustconn.RustConn.desktop AppDir/usr/share/applications/
          cp rustconn/assets/org.rustconn.RustConn.metainfo.xml AppDir/usr/share/metainfo/
          
          # Copy icons
          cp rustconn/assets/icons/hicolor/scalable/apps/org.rustconn.RustConn.svg \
             AppDir/usr/share/icons/hicolor/scalable/apps/
          cp rustconn/assets/icons/hicolor/256x256/apps/org.rustconn.RustConn.png \
             AppDir/usr/share/icons/hicolor/256x256/apps/ || true
          cp rustconn/assets/icons/hicolor/128x128/apps/org.rustconn.RustConn.png \
             AppDir/usr/share/icons/hicolor/128x128/apps/ || true
          cp rustconn/assets/icons/hicolor/64x64/apps/org.rustconn.RustConn.png \
             AppDir/usr/share/icons/hicolor/64x64/apps/ || true
          cp rustconn/assets/icons/hicolor/48x48/apps/org.rustconn.RustConn.png \
             AppDir/usr/share/icons/hicolor/48x48/apps/ || true

      - name: Build AppImage
        run: |
          DEPLOY_GTK_VERSION=4 ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --plugin gtk \
            --output appimage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage
          path: "*.AppImage"

  release:
    name: Create Release
    needs: [build-deb, build-appimage]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download deb artifact
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: dist/

      - name: Download AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: appimage
          path: dist/

      - name: List artifacts
        run: ls -la dist/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
