# Implementation Plan

- [x] 1. Set up IronRDP client infrastructure
  - [x] 1.1 Add IronRDP dependency with feature flag to Cargo.toml
    - Add `ironrdp` crate with conditional compilation via `rdp-embedded` feature
    - Handle potential dependency conflicts with version pinning
    - _Requirements: 10.2_
  - [x] 1.2 Create RdpClient struct following VNC client pattern
    - Implement `RdpClient` with command/event channels
    - Add `RdpClientConfig`, `RdpClientCommand`, `RdpClientEvent` types
    - Follow same architecture as `rustconn-core/src/vnc_client/client.rs`
    - _Requirements: 10.1, 1.1_
  - [x] 1.3 Write property test for RDP config round-trip serialization
    - **Property 21: RDP Config Round-Trip Serialization**
    - **Validates: Requirements 10.4**
  - [x] 1.4 Implement RDP event conversion to unified format
    - Convert IronRDP framebuffer events to `RdpClientEvent::FrameUpdate`
    - Ensure consistent format with VNC events
    - _Requirements: 10.3_
  - [x] 1.5 Write property test for framebuffer event conversion
    - **Property 1: RDP Framebuffer Event Conversion**
    - **Validates: Requirements 1.1, 10.3**

- [x] 2. Implement IronRDP connection and rendering
  - [x] 2.1 Implement connect/disconnect lifecycle
    - Spawn IronRDP in background thread with Tokio runtime
    - Handle connection establishment and authentication
    - Implement proper resource cleanup on disconnect
    - _Requirements: 1.1, 1.6_
  - [x] 2.2 Write property test for resource cleanup
    - **Property 4: Resource Cleanup on Disconnect**
    - **Validates: Requirements 1.6**
  - [x] 2.3 Implement framebuffer rendering in DrawingArea
    - Receive framebuffer updates via event channel
    - Blit pixel data to Cairo surface
    - Queue DrawingArea redraw on updates
    - _Requirements: 1.1_
  - [x] 2.4 Implement fallback to FreeRDP external mode
    - Detect IronRDP availability at runtime
    - Fall back gracefully with user notification
    - _Requirements: 1.5_

- [x] 3. Implement input forwarding for RDP
  - [x] 3.1 Implement mouse coordinate transformation
    - Transform GTK widget coordinates to RDP server coordinates
    - Handle scaling and offset for aspect ratio preservation
    - _Requirements: 1.2_
  - [x] 3.2 Write property test for coordinate transformation
    - **Property 2: Mouse Coordinate Transformation**
    - **Validates: Requirements 1.2**
  - [x] 3.3 Implement keyboard event forwarding
    - Convert GTK keyval to RDP scancode
    - Forward key press/release events
    - _Requirements: 1.3_
  - [x] 3.4 Write property test for key event forwarding
    - **Property 3: Key Event Forwarding**
    - **Validates: Requirements 1.3**
  - [x] 3.5 Implement Ctrl+Alt+Del button
    - Add toolbar button for Ctrl+Alt+Del
    - Send key sequence via `send_ctrl_alt_del()`
    - _Requirements: 1.4_
  - [x] 3.6 Implement dynamic resolution change on resize
    - Detect widget resize events
    - Request resolution change from RDP server
    - _Requirements: 1.7_
  - [x] 3.7 Write property test for resize request generation
    - **Property 5: Resize Request Generation**
    - **Validates: Requirements 1.7**

- [x] 4. Checkpoint - Ensure all tests pass
  - All 660 unit tests pass
  - All 647 property tests pass
  - All 16 integration tests pass
  - GUI crate builds successfully

- [x] 5. Enhance credential resolution
  - [x] 5.1 Add credential verification tracking
    - Add `CredentialStatus` struct with verified flag and timestamp
    - Store verification status in config
    - _Requirements: 2.1, 2.5_
  - [x] 5.2 Implement `resolve_verified()` method
    - Check verification status before returning credentials
    - Return `VerifiedCredentials` with status info
    - _Requirements: 2.1_
  - [x] 5.3 Write property test for verified credentials skip dialog
    - **Property 6: Verified Credentials Skip Dialog**
    - **Validates: Requirements 2.1**
  - [x] 5.4 Write property test for missing credentials require dialog
    - **Property 7: Missing Credentials Require Dialog**
    - **Validates: Requirements 2.2**
  - [x] 5.5 Implement `mark_verified()` and `mark_unverified()` methods
    - Update verification status after auth success/failure
    - _Requirements: 2.3, 2.5_
  - [x] 5.6 Write property test for successful auth marks verified
    - **Property 9: Successful Auth Marks Verified**
    - **Validates: Requirements 2.5**

- [x] 6. Implement unified credential storage
  - [x] 6.1 Implement `select_storage_backend()` method
    - Return KeePass if enabled, otherwise Keyring
    - _Requirements: 3.1_
  - [x] 6.2 Write property test for backend selection priority
    - **Property 10: Backend Selection Priority**
    - **Validates: Requirements 3.1**
  - [x] 6.3 Implement Keyring fallback when KeePass empty
    - Check both backends during resolution
    - Return Keyring credentials if KeePass lookup fails
    - _Requirements: 3.2_
  - [x] 6.4 Write property test for Keyring fallback
    - **Property 11: Keyring Fallback When KeePass Empty**
    - **Validates: Requirements 3.2**
  - [x] 6.5 Implement `needs_keepass_migration()` check
    - Detect credentials in Keyring but not KeePass
    - _Requirements: 3.3_
  - [x] 6.6 Write property test for migration button visibility
    - **Property 12: Migration Button Visibility**
    - **Validates: Requirements 3.3**
  - [x] 6.7 Implement `migrate_to_keepass()` method
    - Copy credentials from Keyring to KeePass
    - Delete from Keyring after successful copy
    - _Requirements: 3.4_
  - [x] 6.8 Implement Keyring availability check
    - Verify libsecret service is accessible
    - _Requirements: 3.5, 3.6_

- [x] 7. Update password dialog
  - [x] 7.1 Change checkbox label to "Save Credentials"
    - Remove "to keyring" from label
    - _Requirements: 3.1_
  - [x] 7.2 Add "Save to KeePass" button
    - Show when migration is needed
    - Call `migrate_to_keepass()` on click
    - _Requirements: 3.3, 3.4_
  - [x] 7.3 Implement dialog pre-fill from connection
    - Pre-fill username and domain from saved settings
    - _Requirements: 2.4_
  - [x] 7.4 Write property test for dialog pre-fill
    - **Property 8: Dialog Pre-fill from Connection**
    - **Validates: Requirements 2.4**
  - [x] 7.5 Skip dialog when credentials verified
    - Check verification status before showing dialog
    - Use saved credentials directly if verified
    - _Requirements: 2.1_

- [x] 8. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 9. Implement connection naming
  - [x] 9.1 Implement `generate_unique_name()` method
    - Check for existing names
    - Append protocol suffix if duplicate
    - Append numeric suffix if still duplicate
    - _Requirements: 4.1, 4.2_
  - [x] 9.2 Write property test for name deduplication
    - **Property 13: Connection Name Deduplication**
    - **Validates: Requirements 4.1, 4.2**
  - [x] 9.3 Implement `normalize_name()` method
    - Remove auto-generated suffix if name is now unique
    - _Requirements: 4.3_
  - [x] 9.4 Write property test for suffix removal
    - **Property 14: Name Suffix Removal**
    - **Validates: Requirements 4.3**
  - [x] 9.5 Integrate naming into connection creation flow
    - Call `generate_unique_name()` when creating connections
    - _Requirements: 4.1_

- [x] 10. Implement SSH key selection
  - [x] 10.1 Update SSH command builder for File auth
    - Add `-i <key_path>` flag
    - Add `-o IdentitiesOnly=yes` flag
    - _Requirements: 5.1, 5.2_
  - [x] 10.2 Write property test for SSH key file flags
    - **Property 15: SSH Key File Flag Generation**
    - **Validates: Requirements 5.1, 5.2**
  - [x] 10.3 Ensure Agent auth doesn't add IdentitiesOnly
    - Skip IdentitiesOnly flag for Agent method
    - _Requirements: 5.3_
  - [x] 10.4 Write property test for Agent no IdentitiesOnly
    - **Property 16: SSH Agent No IdentitiesOnly**
    - **Validates: Requirements 5.3**

- [x] 11. Implement external mode improvements
  - [x] 11.1 Add `/decorations` flag to FreeRDP
    - Include flag in command arguments
    - _Requirements: 6.1_
  - [x] 11.2 Write property test for decorations flag
    - **Property 17: FreeRDP Decorations Flag**
    - **Validates: Requirements 6.1**
  - [x] 11.3 Implement window geometry persistence
    - Save geometry on session close

    - Load geometry on session start
    - _Requirements: 6.2, 6.3_
  - [x] 11.4 Write property test for geometry restoration
    - **Property 18: Window Geometry Restoration**
    - **Validates: Requirements 6.3**
  - [x] 11.5 Respect remember_window_position setting
    - Skip geometry if setting disabled
    - _Requirements: 6.4_
  - [x] 11.6 Write property test for disabled position memory
    - **Property 19: Disabled Position Memory**
    - **Validates: Requirements 6.4**

- [x] 12. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 13. Implement Quick Connect
  - [x] 13.1 Create QuickConnectBar widget
    - Add hostname entry, protocol dropdown, connect button
    - _Requirements: 7.1, 7.2_
  - [x] 13.2 Implement temporary connection creation
    - Create non-persistent Connection object
    - Mark as Quick Connect session
    - _Requirements: 7.1, 7.2_
  - [x] 13.3 Show password dialog when needed
    - Trigger dialog for auth-required connections
    - _Requirements: 7.3_
  - [x] 13.4 Ensure Quick Connect doesn't persist
    - Don't save to connection list
    - Clean up after session ends
    - _Requirements: 7.4_
  - [x] 13.5 Write property test for no persistence
    - **Property 20: Quick Connect No Persistence**
    - **Validates: Requirements 7.4**

- [x] 14. Implement Wayland subsurface integration
  - [x] 14.1 Create WaylandSubsurface struct
    - Manage wl_surface and wl_subsurface
    - Handle shared memory pool
    - _Requirements: 8.1_
  - [x] 14.2 Implement subsurface initialization
    - Get Wayland display from GTK
    - Create subsurface attached to parent
    - _Requirements: 8.1_
  - [x] 14.3 Implement position updates
    - Update subsurface position on parent move/resize
    - _Requirements: 8.2_
  - [x] 14.4 Implement framebuffer blitting
    - Copy pixel data to shared memory buffer
    - Damage and commit surface
    - _Requirements: 8.3_
  - [x] 14.5 Implement X11 fallback
    - Detect X11 vs Wayland at runtime
    - Use Cairo rendering on X11
    - _Requirements: 8.4_

- [x] 15. Implement SPICE protocol support
  - [x] 15.1 Create SpiceClient struct
    - Follow VNC/RDP client pattern
    - Implement command/event channels
    - _Requirements: 9.1_
  - [x] 15.2 Implement SPICE connection
    - Connect to SPICE server
    - Handle authentication
    - _Requirements: 9.1_
  - [x] 15.3 Implement display rendering
    - Receive framebuffer updates
    - Render in embedded mode
    - _Requirements: 9.2_
  - [x] 15.4 Implement input forwarding
    - Forward keyboard and mouse events
    - _Requirements: 9.3_
  - [x] 15.5 Implement virt-viewer fallback
    - Detect native client availability
    - Fall back to virt-viewer if unavailable
    - _Requirements: 9.4_

- [x] 16. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
