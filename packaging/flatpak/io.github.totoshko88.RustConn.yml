app-id: io.github.totoshko88.RustConn
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: rustconn

finish-args:
  # Wayland/X11 access
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  # Audio for RDP sessions
  - --socket=pulseaudio
  # Network access for SSH/RDP/VNC/SPICE
  - --share=network
  # Home directory access for SSH keys and config
  - --filesystem=home/.ssh:ro
  # SSH agent
  - --socket=ssh-auth
  # D-Bus access for secret service (GNOME Keyring, KWallet)
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.kwalletd5
  - --talk-name=org.kde.kwalletd6
  # KeePassXC proxy access
  - --talk-name=org.keepassxc.KeePassXC.BrowserServer
  # System tray (StatusNotifierItem)
  - --talk-name=org.kde.StatusNotifierWatcher
  # Serial device access for picocom
  - --device=all
  # Downloads directory for SFTP file transfers via mc
  - --filesystem=xdg-download:create

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
  env:
    CARGO_HOME: /run/build/rustconn/cargo
    RUST_BACKTRACE: '1'

modules:
  - name: vte
    buildsystem: meson
    config-opts:
      - -Dglade=false
      - -Dgtk3=false
      - -Dgtk4=true
      - -Dvapi=false
      - -Dicu=false
      - -Dgir=false
      - -Ddocs=false
    sources:
      - type: archive
        url: https://download.gnome.org/sources/vte/0.78/vte-0.78.7.tar.xz
        sha256: 6fd1edc332d9f9519ce4c0f07135fdf72d64dfd990dc4fabc6ce91b1b7e83dd0

  - name: sshpass
    buildsystem: autotools
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/sshpass/sshpass-1.10.tar.gz
        sha256: ad1106c203cbb56185ca3bad8c6ccafca3b4064696194da879f81c8d7bdfeeda

  - name: inetutils
    buildsystem: autotools
    config-opts:
      - --disable-servers
      - --disable-ifconfig
      - --disable-logger
      - --disable-syslogd
      - --disable-hostname
      - --disable-traceroute
      - --disable-talk
      - --disable-rcp
      - --disable-rlogin
      - --disable-rsh
      - --disable-rexec
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/inetutils/inetutils-2.7.tar.gz
        sha256: a156be1cde3c5c0ffefc262180d9369a60484087907aa554c62787d2f40ec086

  - name: picocom
    buildsystem: simple
    build-commands:
      - make
      - install -Dm755 picocom /app/bin/picocom
    sources:
      - type: archive
        url: https://github.com/npat-efault/picocom/archive/refs/tags/3.1.tar.gz
        sha256: e6761ca932ffc6d09bd6b11ff018bdaf70b287ce518b3282d29e0270e88420bb

  - name: libsecret
    buildsystem: meson
    config-opts:
      - -Dgtk_doc=false
      - -Dintrospection=false
      - -Dvapi=false
      - -Dmanpage=false
      - -Dcrypto=disabled
      - -Dbash_completion=disabled
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libsecret/0.21/libsecret-0.21.7.tar.xz
        sha256: 6b452e4750590a2b5617adc40026f28d2f4903de15f1250e1d1c40bfd68ed55e

  - name: mc
    buildsystem: autotools
    config-opts:
      - --without-x
      - --with-screen=ncurses
      - --disable-vfs-sftp
    sources:
      - type: archive
        url: http://ftp.midnight-commander.org/mc-4.8.33.tar.xz
        sha256: cae149d42f844e5185d8c81d7db3913a8fa214c65f852200a9d896b468af164c

  - name: rustconn
    buildsystem: simple
    build-options:
      env:
        CARGO_NET_OFFLINE: 'true'
    build-commands:
      - cargo build --release -p rustconn -p rustconn-cli
      - install -Dm755 target/release/rustconn /app/bin/rustconn
      - install -Dm755 target/release/rustconn-cli /app/bin/rustconn-cli
      - install -Dm644 rustconn/assets/io.github.totoshko88.RustConn.desktop /app/share/applications/io.github.totoshko88.RustConn.desktop
      - install -Dm644 rustconn/assets/io.github.totoshko88.RustConn.metainfo.xml /app/share/metainfo/io.github.totoshko88.RustConn.metainfo.xml
      - install -Dm644 rustconn/assets/icons/hicolor/scalable/apps/io.github.totoshko88.RustConn.svg /app/share/icons/hicolor/scalable/apps/io.github.totoshko88.RustConn.svg
      # Install locale files (compile .po to .mo)
      - |
        for po_file in po/*.po; do
          [ -f "$po_file" ] || continue
          lang=$(basename "$po_file" .po)
          mkdir -p /app/share/locale/$lang/LC_MESSAGES
          msgfmt -o /app/share/locale/$lang/LC_MESSAGES/rustconn.mo "$po_file"
        done
    sources:
      - type: git
        url: https://github.com/totoshko88/RustConn.git
        tag: v0.9.0
      - cargo-sources.json
